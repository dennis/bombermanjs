<html>
<head>
	<title>Bomberman JS</title>
	<script src="/socket.io/socket.io.js"></script>
	<style>
		canvas {
			xposition: absolute;
			top: 0px;
			left: 0px;
			background: transparent;
			border: 1px solid black;
		}
	</style>
</head>
<body>
<h1>Bomberman JS</h1>
<div id="gamearea">
<canvas id="background">
Your browser does not support canvas
</canvas>
</div>
<script>
    // Drawable
    function Drawable() {};
    Drawable.prototype.canvasWidth = null;
    Drawable.prototype.canvasHeight = null;
    Drawable.prototype.context = null;
    Drawable.prototype.init = function(x, y) {
        this.x = x;
        this.y = y;
    }
    Drawable.prototype.draw = function() {
        console.log("Drawable.prototype");
    }

    // Background extends Drawable
    function Background(canvasId, tileSet) {
		this.layers = [];
		this.tileSet = tileSet;
		this.dirty = false;

        this.backgroundCanvas = document.getElementById('background');
        if(this.backgroundCanvas.getContext) {
           this.context = this.backgroundCanvas.getContext('2d');

           this.init(0,0);
        }
        else {
            throw new "No canvas support";
        }
	}

    Background.prototype = new Drawable();
	Background.prototype.populate = function(layer) {
		this.layers.push(layer);
		this.dirty = true;
	}
    Background.prototype.draw = function() {
		if(!this.dirty) {
			return;
		}

		for(var i = 0; i < this.layers.length; i++) {
			for(var pos = 0; pos < this.layers[i].data.length; pos++) {
				this.tileSet.draw(this.context,pos,this.layers[i].data[pos]-1);
			}
		}

		this.dirty = false;
    }

	// TileSet
	function TileSet(tileSetData, sprite) {
		this.sprite = sprite;

		this.tileWidth = tileSetData.tilewidth;
		this.tileHeight = tileSetData.tileheight;

		this.cols = tileSetData.imagewidth / this.tileWidth;
		this.rows = tileSetData.imageheight / this.tileHeight;
	};

	TileSet.prototype.draw = function(context, pos, tileNum) {
		var tileX = tileNum % this.cols;
		var tileY = (tileNum - tileX) / this.cols;

		var posX = pos % this.cols;
		var posY = (pos - posX) / this.cols;

		context.drawImage(this.sprite, 
			tileX * this.tileWidth, tileY * this.tileHeight, this.tileWidth, this.tileHeight, 
			posX * this.tileWidth, posY * this.tileHeight, this.tileWidth, this.tileHeight);
	}
	
	TileSet.prototype.getTileWidth = function() {
		return this.tileWidth;
	}

	TileSet.prototype.getTileHeight = function() {
		return this.tileHeight;
	}


    // Level
    function Level(levelMap, tileSet) {
		this.tileSet = tileSet;
        this.background = new Background('background', tileSet);

		console.log("Loading map");

        for(var i = 0; i < levelMap.layers.length; i++) {
			if(levelMap.layers[i].type == "tilelayer" && levelMap.layers[i].properties) {
 				if(levelMap.layers[i].properties.type == "background" || levelMap.layers[i].properties.type == "blocking") {
					console.log("Loaded layer #" + i + " " + levelMap.layers[i].name + " (" + levelMap.layers[i].properties.type + ")");
					this.background.populate(levelMap.layers[i]);
				}
			}
        }
    };

    Level.prototype.draw = function() {
        this.background.draw(this.tileSet);
    }

    // main
    var socket = io.connect(document.location.origin);
    var level = null;
	var levelMap = null;

    socket.on('new-level', function (data) {
		levelMap = data;
		console.log("EVENT: new-level");
        // calculate width and height
        var mapWidth = levelMap.width*levelMap.tilewidth;
        var mapHeight = levelMap.height*levelMap.tileheight;
        document.getElementById('background').width=mapWidth
        document.getElementById('background').height=mapHeight

		// load asset
		var tilesImg = new Image();
		tilesImg.src = levelMap.tilesets[0].image; //"/bomb_party_v4.png";
		tilesImg.onload = function() {
			console.log("Graphics loaded: ", tilesImg);
			var tileSet = new TileSet(levelMap.tilesets[0], tilesImg);
			level = new Level(levelMap, tileSet);
			console.log("ready");
			animate();
		}
    });

    function animate() {
        requestAnimFrame(animate);
		level.draw();
    }

    window.requestAnimFrame = (function(){
        return window.requestAnimationFrame ||
        window.webkitRequestAnimationFrame ||
        window.mozRequestAnimationFrame ||
        window.oRequestAnimationFrame ||
        window.msRequestAnimationFrame ||
        function(/* function */ callback, /* DOMElement */ element){
            window.setTimeout(callback, 1000 / 60);
        };
    })();
</script>
</body>
</html>
